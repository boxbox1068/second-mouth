<!DOCTYPE html>
<meta charset="utf-8">
<title>Second Mouth</title>
<script>
/*
  class Speaker {
    #utteranceQueue;
    constructor() {
      this.#utteranceQueue = [];
    }

    speak(text, interrupt) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      utterance.rate = 1;
      utterance.pitch = 1;
      utterance.volume = 1;
      ['end', 'error'].forEach(type => {
        utterance.addEventListener(type, event => {
          const utterance = this.#utteranceQueue.shift();
          if (!(utterance)) {
            return;
          }
          speechSynthesis.speak(utterance);
        });
      });
      if (interrupt) {
        speechSynthesis.cancel();
        this.#utteranceQueue.splice(0);
      }
      this.#utteranceQueue.push(utterance);
    }
  }
*/



/*
  const qs = document.querySelector.bind(document);
  const speakQueue = [];
  window.addEventListener('load', main);

  function main(event) {
    qs('#text-input').addEventListener('keydown', event => {
      if (event.isComposing) return;
      if (event.keyCode === 0x0D) {
        if (event.ctrlKey) {
          alert(1)
        } else {
          const text = qs('#text-input').value;
          qs('#text-input').value = '';
          speakQueue.push(text);
          speak();
        }
      }
    });




    qs('#send-button').addEventListener('click', event => {
      send();
    });
    // エラー対策: 最初の呼び出し時に空の配列が返ることがあるので一旦呼び出しておく
    {
      speechSynthesis.getVoices();
    }
  }

  function send() {
    const text = qs('#text-input').value;
    qs('#text-input').value = '';
    speak(text);
  }

  function speak(text) {
    if (!text) return;
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    utterance.rate = 1;
    utterance.pitch = 1;
    utterance.volume = 1;
//    utterance.voice = 
    speechSynthesis.speak(utterance);
  }
*/


const qs = document.querySelector.bind(document);

window.addEventListener('DOMContentLoaded', main);

function main() {
  window.addEventListener('beforeunload', stopSpeaking);
  qs('#send-button').addEventListener('click', send);
  qs('#text-input').addEventListener('keydown', handleTextInputKeyDown);
  qs('#text-input').focus();
  {
    // エラー対策: 最初の呼び出し時に空の配列が返ることがあるので一旦呼び出しておく
    speechSynthesis.getVoices();
  }
}

function handleTextInputKeyDown(event) {
  if (event.isComposing) {
    return;
  }
  if (event.keyCode === 0x0D) {
    event.preventDefault();
    if (event.ctrlKey) {
      stopSpeaking();
    }
    send();
  }
}

function stopSpeaking() {
  speechSynthesis.cancel();
}

function send() {
  const element = qs('#text-input');
  const text = element.value;
  element.value = '';
  speak(text);

  const hoge = document.createElement('div');
  hoge.innerHTML = text;
  hoge.classList.add('history-item');
  hoge.addEventListener('click', () => speak(text));
  qs('#history-output').appendChild(hoge);

  qs('#text-input').focus();

}

function speak(text) {
  text = adjustText(text);
  const hoge = text.match(/^[a-z]>/i)?.[0] || '';
  const fuga = text.substr(hoge.length);
  const utterance = new SpeechSynthesisUtterance();
  utterance.pitch = 1;
  utterance.rate = 1;
  utterance.volume = 1;
  utterance.text = fuga;
  if (/^e>$/i.test(hoge)) {
    utterance.lang = 'en-US';
  } else {
    utterance.lang = 'ja-JP';
  }
  utterance.voice = getVoice(utterance.lang);
  speechSynthesis.speak(utterance);
}

function adjustText(text) {
  return text;
}

function getVoice(lang) {
  const voices = speechSynthesis.getVoices();
  const voice = voices.filter(voice => voice.lang === lang)[0];
  return voice;
}
</script>

<style>
  * {
    box-sizing: border-box;
    overflow: hidden;
  }

  /* GRID LAYOUT */
  #container {
    display: grid;
    grid-template-rows: 1fr 80px;
    grid-template-columns: 60% 40%;
    position: fixed;
    top: 0; right: 0; bottom: 0; left: 0;
  }
  #history-panel {
    grid-row: 1 / 2;
    grid-column: 1 / 2;
    background-color: yellow;
  }
  #input-panel {
    grid-row: 2 / 3;
    grid-column: 1 / 2;
    background-color: red;
  }
  #favorites-panel {
    grid-row: 1 / 3;
    grid-column: 2 / 3;
    background-color: purple;
  }
/*
  #history-output {
border: 5px solid green;
    display: flex;
    overflow: scroll;
    flex-direction: column;
    justify-content: flex-end;
    height: 100%;
background-color: blue;
  }
*/
  #history-output {
    --hhhh: 8px;
    display: flex;
    flex-flow: column nowrap;
    height: 100%;
    max-height: 100%;
    overflow-y: auto;
  }
  #history-output::before {
    display: block;
    margin-top: auto;
    content: "";
  }
  #history-output::after {
    display: block;
    margin-bottom: var(--hhhh);
    content: "";
  }

  .history-item {
    --border-width: 2px;
    --border-color: gray;
    display: block;
    flex-shrink: 0;
    position: relative;
    margin: var(--hhhh) 5% calc(var(--hhhh) * 2.5);
    padding: .5em 1.5em;
    overflow: visible;
    border-radius: 10px;
    border: var(--border-width) solid var(--border-color);
    background-color: white;
  }
  .history-item::after {
    --width: var(--hhhh);
    --height: calc(var(--hhhh) * 2);
    display: block;
    position: absolute;
    top: 100%; left: 50%;
    width: var(--width) ; height: var(--height);
    margin-left: calc(var(--width) / 2 * -1);
    background:
      linear-gradient(to top right,transparent 50%, var(--border-color) 50%, var(--border-color) calc(50% + var(--border-width)), white calc(50% + var(--border-width))) no-repeat top left/50% 100%,
      linear-gradient(to top left,transparent 50%, var(--border-color) 50%, var(--border-color) calc(50% + var(--border-width)), white calc(50% + var(--border-width))) no-repeat top right/50% 100%;
/*

    background:
      linear-gradient(to top right,transparent 50%, black 50%, black calc(50% + 8px), white calc(50% + 8px)) no-repeat top left/50% 100%,
      linear-gradient(to top left, white 50%, yellowgreen 50%) no-repeat top right/50% 100%;

background:
		linear-gradient(to top right,white 50%, navy 50%) no-repeat top left/50% 100%,
		linear-gradient(to top left, white 50%, yellowgreen 50%) no-repeat top right/50% 100%;
*/
    content: "";
  }

  #text-input {
    height: 3lh;
    resize: none;
  }
</style>


<style>
</style>
<div id="container">
  <div id="history-panel">
    <div id="history-output">
    </div>
  </div>
  <div id="input-panel">
    <textarea id="text-input">hoge</textarea>
    <button id="send-button">Send</button>
  </div>
  <div id="favorites-panel">
  </div>
</div>
